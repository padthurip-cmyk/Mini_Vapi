<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini Voice Bridge - Pro</title>
    <style>
        :root { --bg: #0a0a0f; --bg2: #12121a; --bg3: #1a1a25; --accent: #00d4aa; --text: #fff; --text2: #8b8b9e; --border: #2a2a3a; --danger: #ff6b6b; --warning: #ffd93d; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }
        .full { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .logo { font-size: 20px; font-weight: 700; }
        .logo span { color: var(--accent); }
        .btn { background: var(--bg2); border: 1px solid var(--border); padding: 10px 16px; color: var(--text); border-radius: 8px; cursor: pointer; font-size: 14px; transition: 0.3s; }
        .btn:hover { border-color: var(--accent); }
        .btn.primary { background: var(--accent); color: #000; border: none; font-weight: 600; }
        .status-box { background: var(--bg2); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center; }
        .status-icon { font-size: 40px; margin-bottom: 10px; }
        .card { background: var(--bg2); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 15px; }
        .row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 14px; }
        .row:last-child { border: none; }
        .ok { color: var(--accent); } .err { color: var(--danger); } .warn { color: var(--warning); }
        .input-group { margin-bottom: 12px; }
        .input-group label { display: block; font-size: 12px; color: var(--text2); margin-bottom: 4px; }
        .input-group input { width: 100%; background: var(--bg3); border: 1px solid var(--border); padding: 10px; color: #fff; border-radius: 6px; }
        .log { background: #000; color: #0f0; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 11px; height: 120px; overflow-y: auto; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="full">
        <div class="header">
            <div class="logo">üéôÔ∏è Hey <span>Mini</span></div>
            <button class="btn primary" id="mainBtn" onclick="toggleMain()">üëÇ Start Listening</button>
        </div>

        <div class="status-box" id="statusBox">
            <div class="status-icon" id="statusIcon">üé§</div>
            <h2 id="statusTitle">System Ready</h2>
            <p id="statusSub" style="color: var(--text2)">Configure keys to start</p>
        </div>

        <div class="card">
            <div class="row"><span>SDK Connection</span><span id="statSDK" class="warn">Disconnected</span></div>
            <div class="row"><span>Mic Permission</span><span id="statMic" class="warn">Checking...</span></div>
            <div class="row"><span>Wake Word</span><span id="statWake" class="warn">Inactive</span></div>
        </div>

        <div class="card">
            <div class="input-group">
                <label>Vapi Public Key (pk_...)</label>
                <input type="text" id="vKey" placeholder="pk_xxxxxxxxxxxx">
            </div>
            <div class="input-group">
                <label>Assistant ID</label>
                <input type="text" id="vAsst" placeholder="uuid-uuid-uuid">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn" onclick="saveSettings()">üíæ Save & Connect</button>
                <button class="btn" onclick="forceMic()">üé§ Force Mic Access</button>
            </div>
        </div>

        <div class="log" id="sysLog"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@vapi-ai/web@1.0.1/dist/vapi.browser.js"></script>

    <script>
        const store = { vapi: null, rec: null, active: false, calling: false };
        const logEl = document.getElementById('sysLog');

        function log(msg, color = '') {
            const div = document.createElement('div');
            div.style.color = color;
            div.textContent = `${new Date().toLocaleTimeString()} - ${msg}`;
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function forceMic() {
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true });
                log("Microphone access granted manually!", "#00d4aa");
                document.getElementById('statMic').textContent = "Allowed";
                document.getElementById('statMic').className = "ok";
            } catch (e) {
                log("Mic Access Failed: " + e.message, "#ff6b6b");
            }
        }

        function saveSettings() {
            const key = document.getElementById('vKey').value.trim();
            const asst = document.getElementById('vAsst').value.trim();
            localStorage.setItem('vKey', key);
            localStorage.setItem('vAsst', asst);
            log("Settings saved. Reconnecting...");
            location.reload();
        }

        function initVapi() {
            const key = localStorage.getItem('vKey');
            const asst = localStorage.getItem('vAsst');
            if (!key || !asst) return log("Keys missing in settings", "orange");

            document.getElementById('vKey').value = key;
            document.getElementById('vAsst').value = asst;

            try {
                store.vapi = new Vapi(key);
                document.getElementById('statSDK').textContent = "Connected";
                document.getElementById('statSDK').className = "ok";

                store.vapi.on('call-start', () => {
                    store.calling = true;
                    updateUI("üó£Ô∏è", "Call Active", "Mini is listening...");
                });

                store.vapi.on('call-end', () => {
                    store.calling = false;
                    updateUI("üé§", "System Ready", "Waiting for wake word...");
                    startWakeListener();
                });

                store.vapi.on('error', (e) => log("Vapi Error: " + (e.message || e), "#ff6b6b"));
            } catch (e) {
                log("SDK Init Failed: " + e.message, "#ff6b6b");
            }
        }

        function startWakeListener() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return log("Browser doesn't support Speech API", "#ff6b6b");

            store.rec = new SpeechRecognition();
            store.rec.continuous = true;
            store.rec.lang = 'en-US';

            store.rec.onresult = (event) => {
                if (store.calling) return;
                const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase();
                log("Heard: " + transcript);
                if (transcript.includes("hey mini") || transcript.includes("mini")) {
                    log("Wake word detected!", "#00d4aa");
                    triggerCall();
                }
            };

            store.rec.onerror = (e) => {
                if (e.error === 'not-allowed') log("Mic blocked by browser", "#ff6b6b");
                if (e.error !== 'aborted') setTimeout(startWakeListener, 1000);
            };

            store.rec.onend = () => { if (!store.calling) store.rec.start(); };
            store.rec.start();
            document.getElementById('statWake').textContent = "Active";
            document.getElementById('statWake').className = "ok";
        }

        function triggerCall() {
            const asst = localStorage.getItem('vAsst');
            if (store.vapi && asst) {
                store.rec.stop();
                store.vapi.start(asst);
                const beep = new AudioContext();
                const o = beep.createOscillator();
                const g = beep.createGain();
                o.connect(g); g.connect(beep.destination);
                o.start(); o.stop(beep.currentTime + 0.1);
            }
        }

        function updateUI(icon, title, sub) {
            document.getElementById('statusIcon').textContent = icon;
            document.getElementById('statusTitle').textContent = title;
            document.getElementById('statusSub').textContent = sub;
        }

        function toggleMain() {
            if (!store.active) {
                store.active = true;
                document.getElementById('mainBtn').textContent = "‚è∏Ô∏è Stop All";
                startWakeListener();
                forceMic();
            } else {
                location.reload();
            }
        }

        window.onload = () => {
            initVapi();
            log("System Loaded. Click 'Start' to begin.");
        };
    </script>
</body>
</html>
