<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vapi AI Fix</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #6366f1; }
        body { font-family: sans-serif; background: var(--bg); color: white; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .container { background: var(--card); padding: 2rem; border-radius: 16px; width: 380px; border: 1px solid #334155; text-align: center; }
        input { width: 100%; padding: 10px; background: #0f172a; border: 1px solid #475569; border-radius: 6px; color: #fff; margin-bottom: 10px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; background: var(--accent); color: white; }
        button:disabled { background: #334155; cursor: not-allowed; }
        #logs { font-family: monospace; font-size: 0.7rem; background: #000; color: #22c55e; padding: 10px; height: 120px; overflow-y: auto; margin-top: 1rem; border-radius: 4px; text-align: left; }
        .loader-text { font-size: 0.8rem; color: #94a3b8; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div id="loader-status" class="loader-text">‚è≥ Loading Vapi Engine...</div>
    
    <input type="text" id="pub-key" placeholder="Vapi Public Key (pk_...)">
    <input type="text" id="ast-id" placeholder="Assistant ID (uuid...)">

    <button id="start-btn" disabled>Waiting for SDK...</button>
    <button id="stop-btn" style="display:none; background: #ef4444; margin-top: 10px;">Stop Assistant</button>

    <div id="logs">Initializing system...</div>
</div>

<script>
    const logEl = document.getElementById('logs');
    const startBtn = document.getElementById('start-btn');
    const loaderStatus = document.getElementById('loader-status');
    let vapi = null;

    function addLog(msg) {
        const time = new Date().toLocaleTimeString();
        logEl.innerHTML += `<div>[${time}] ${msg}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    // --- STEP 1: PROPER SCRIPT LOADING ---
    function loadVapiScript() {
        return new Promise((resolve, reject) => {
            if (window.Vapi) return resolve();
            const script = document.createElement('script');
            script.src = "https://cdn.jsdelivr.net/gh/VapiAI/html-sdk@latest/dist/vapi.js";
            script.onload = () => resolve();
            script.onerror = () => reject();
            document.head.appendChild(script);
        });
    }

    // --- STEP 2: INITIALIZE ---
    async function setup() {
        try {
            await loadVapiScript();
            addLog("Vapi SDK loaded successfully.");
            loaderStatus.innerText = "‚úÖ SDK Ready";
            loaderStatus.style.color = "#22c55e";
            startBtn.innerText = "Save & Start Assistant";
            startBtn.disabled = false;
        } catch (e) {
            addLog("‚ùå Failed to load SDK. Check internet/firewall.");
            loaderStatus.innerText = "‚ùå Connection Failed";
        }
    }

    async function startCall() {
        const pubKey = document.getElementById('pub-key').value.trim();
        const astId = document.getElementById('ast-id').value.trim();

        if (!pubKey || !astId) {
            addLog("Error: Missing Keys!");
            return;
        }

        try {
            vapi = new Vapi(pubKey);
            addLog("Connecting to assistant...");
            
            vapi.start(astId);

            vapi.on('call-start', () => {
                addLog("üî¥ Call active! Speak now.");
                startBtn.style.display = 'none';
                document.getElementById('stop-btn').style.display = 'block';
            });

            vapi.on('call-end', () => {
                addLog("Call ended.");
                startBtn.style.display = 'block';
                document.getElementById('stop-btn').style.display = 'none';
            });

            vapi.on('error', (e) => addLog("Vapi Error: " + e.message));

        } catch (err) {
            addLog("Setup Error: " + err.message);
        }
    }

    startBtn.addEventListener('click', startCall);
    document.getElementById('stop-btn').addEventListener('click', () => vapi?.stop());

    // Run setup on load
    setup();
</script>

</body>
</html>
